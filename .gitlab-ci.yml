# GitLab CI/CD Pipeline for Portfolio Website
# Architecture: AWS ECR + ECS Fargate deployment with Terraform
# Domain: nwalker.cc (staging.nwalker.cc for staging)

stages:
  - validate
  - build
  - terraform-plan
  - terraform-apply
  - deploy

variables:
  AWS_DEFAULT_REGION: us-east-1
  TF_IN_AUTOMATION: "true"
  DOCKER_BUILDKIT: "1"
  # Set in GitLab CI/CD variables:
  # - AWS_ACCESS_KEY_ID
  # - AWS_SECRET_ACCESS_KEY
  # - AWS_ACCOUNT_ID

# Default settings
default:
  image: alpine:latest
  before_script:
    - apk add --no-cache curl

# Cache for Terraform
.terraform_cache: &terraform_cache
  cache:
    key: terraform-${CI_COMMIT_REF_SLUG}
    paths:
      - .terraform/
      - .terraform.lock.hcl

# ============================================================================
# STAGE: VALIDATE
# ============================================================================

validate:dockerfile:
  stage: validate
  image: hadolint/hadolint:latest-alpine
  script:
    - hadolint Dockerfile || true
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'

validate:terraform:
  stage: validate
  image:
    name: hashicorp/terraform:1.6
    entrypoint: [""]  # Override entrypoint to allow shell scripts
  before_script: []  # Override default
  script:
    - cd infra/envs/staging
    - terraform init -backend=false
    - terraform fmt -check -recursive ../../
    - terraform validate
  <<: *terraform_cache
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# ============================================================================
# STAGE: BUILD
# ============================================================================

build:image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache aws-cli
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
  script:
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA}
    - export REGISTRY=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
    - export REPO=portfolio-website
    - |
      docker build \
        --tag $REGISTRY/$REPO:$IMAGE_TAG \
        --tag $REGISTRY/$REPO:latest \
        --cache-from $REGISTRY/$REPO:latest \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        .
    - docker push $REGISTRY/$REPO:$IMAGE_TAG
    - docker push $REGISTRY/$REPO:latest
    - echo "IMAGE_TAG=$IMAGE_TAG" >> build.env
  artifacts:
    reports:
      dotenv: build.env
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'

# ============================================================================
# STAGE: TERRAFORM PLAN
# ============================================================================

plan:staging:
  stage: terraform-plan
  image:
    name: hashicorp/terraform:1.6
    entrypoint: [""]
  before_script: []
  script:
    - cd infra/envs/staging
    - terraform init
    - terraform plan -var="image_tag=${IMAGE_TAG:-latest}" -out=plan.tfplan
  artifacts:
    paths:
      - infra/envs/staging/plan.tfplan
    expire_in: 1 week
  <<: *terraform_cache
  needs:
    - job: build:image
      optional: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'

plan:production:
  stage: terraform-plan
  image:
    name: hashicorp/terraform:1.6
    entrypoint: [""]
  before_script: []
  script:
    - cd infra/envs/production
    - terraform init
    - terraform plan -var="image_tag=${IMAGE_TAG}" -out=plan.tfplan
  artifacts:
    paths:
      - infra/envs/production/plan.tfplan
    expire_in: 1 week
  <<: *terraform_cache
  needs:
    - job: build:image
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'

# ============================================================================
# STAGE: TERRAFORM APPLY
# ============================================================================

apply:staging:
  stage: terraform-apply
  image:
    name: hashicorp/terraform:1.6
    entrypoint: [""]
  before_script: []
  script:
    - cd infra/envs/staging
    - terraform init
    - terraform apply -auto-approve plan.tfplan
  <<: *terraform_cache
  needs:
    - job: plan:staging
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  environment:
    name: staging
    url: https://staging.nwalker.cc

apply:production:
  stage: terraform-apply
  image:
    name: hashicorp/terraform:1.6
    entrypoint: [""]
  before_script: []
  script:
    - cd infra/envs/production
    - terraform init
    - terraform apply -auto-approve plan.tfplan
  <<: *terraform_cache
  needs:
    - job: plan:production
      artifacts: true
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  when: manual
  environment:
    name: production
    url: https://nwalker.cc

# ============================================================================
# STAGE: DEPLOY (ECS Service Update)
# ============================================================================

deploy:staging:
  stage: deploy
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  before_script: []
  script:
    - |
      aws ecs update-service \
        --cluster portfolio-cluster \
        --service portfolio-staging \
        --force-new-deployment \
        --region $AWS_DEFAULT_REGION
    - |
      aws ecs wait services-stable \
        --cluster portfolio-cluster \
        --services portfolio-staging \
        --region $AWS_DEFAULT_REGION
  needs:
    - job: apply:staging
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  environment:
    name: staging
    url: https://staging.nwalker.cc

deploy:production:
  stage: deploy
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  before_script: []
  script:
    - |
      aws ecs update-service \
        --cluster portfolio-cluster \
        --service portfolio-production \
        --force-new-deployment \
        --region $AWS_DEFAULT_REGION
    - |
      aws ecs wait services-stable \
        --cluster portfolio-cluster \
        --services portfolio-production \
        --region $AWS_DEFAULT_REGION
  needs:
    - job: apply:production
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  when: manual
  environment:
    name: production
    url: https://nwalker.cc
